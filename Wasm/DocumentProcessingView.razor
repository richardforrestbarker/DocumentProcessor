@namespace DocumentProcessor.Wasm.Components
@using System.Timers
@using System.Text.Json
@using System.IO
@using Microsoft.AspNetCore.Components.Forms
@using DocumentProcessor.Data.Ocr;
@using DocumentProcessor.Data.Ocr.Messages;
@using DocumentProcessor.Data.Messages;
@using Microsoft.Extensions.Logging

@inject IDocumentProcessor DocumentProcessingClient
@inject ILogger<DocumentProcessingView> Logger
@implements IDisposable

<div class="document-processing-view">
    <h3>Document Processing Live View</h3>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error:</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    <div class="row">
        <!-- Left Panel: Source Image -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>@(currentPhase == ProcessingPhase.Preprocessing ? "Source Image" : "Preprocessing Result")</span>
                    @if (currentPhase == ProcessingPhase.Ocr && !string.IsNullOrEmpty(preprocessedImageBase64))
                    {
                        <span class="badge bg-success">Accepted</span>
                    }
                </div>
                <div class="card-body text-center">
                    @if (!string.IsNullOrEmpty(sourceImageBase64))
                    {
                        <img src="data:image/png;base64,@(currentPhase == ProcessingPhase.Ocr && !string.IsNullOrEmpty(preprocessedImageBase64) ? preprocessedImageBase64 : sourceImageBase64)"
                             class="img-fluid"
                             alt="@(currentPhase == ProcessingPhase.Ocr ? "Preprocessing Result" : "Source Image")"
                             style="max-height: 500px;" />
                    }
                    else
                    {
                        <div class="text-muted p-5">
                            <i class="bi bi-image" style="font-size: 4rem;"></i>
                            <p>No image selected</p>
                            <InputFile OnChange="HandleFileSelection" accept="image/*" class="form-control" id="imageInput" />
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Right Panel: Processing Result -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>
                        @switch (currentPhase)
                        {
                            case ProcessingPhase.Preprocessing:
                                <text>Preprocessing Result</text>
                                break;
                            case ProcessingPhase.Ocr:
                                <text>OCR Result</text>
                                break;
                        }
                    </span>
                    @if (isLoading)
                    {
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    }
                    else if (timerActive)
                    {
                        <!-- Timer Progress Circle -->
                        <div class="timer-progress" title="Updating in @timerSecondsRemaining seconds">
                            <svg width="24" height="24" viewBox="0 0 36 36">
                                <path d="M18 2.0845
                                        a 15.9155 15.9155 0 0 1 0 31.831
                                        a 15.9155 15.9155 0 0 1 0 -31.831"
                                      fill="none"
                                      stroke="#e0e0e0"
                                      stroke-width="3" />
                                <path d="M18 2.0845
                                        a 15.9155 15.9155 0 0 1 0 31.831
                                        a 15.9155 15.9155 0 0 1 0 -31.831"
                                      fill="none"
                                      stroke="#007bff"
                                      stroke-width="3"
                                      stroke-dasharray="@timerProgress, 100" />
                            </svg>
                            <span class="ms-1">@timerSecondsRemaining s</span>
                        </div>
                    }
                </div>
                <div class="card-body text-center">
                    @if (isLoading)
                    {
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 p-5">
                            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                                <span class="visually-hidden">Processing...</span>
                            </div>
                            <p class="mt-3 text-muted">Processing image...</p>
                        </div>
                    }
                    else if (currentPhase == ProcessingPhase.Preprocessing && !string.IsNullOrEmpty(preprocessedImageBase64))
                    {
                        <img src="data:image/png;base64,@preprocessedImageBase64"
                             class="img-fluid"
                             alt="Preprocessed Image"
                             style="max-height: 500px;" />
                    }
                    else if (currentPhase == ProcessingPhase.Ocr && ocrResult != null)
                    {
                        <div class="ocr-result text-start" style="max-height: 500px; overflow-y: auto;">
                            <h5>Extracted Text:</h5>
                            <pre class="bg-light p-3 rounded">@ocrResult.RawOcrText</pre>

                            @if (ocrResult.Words?.Count > 0)
                            {
                                <h6>Words detected: @ocrResult.Words.Count</h6>
                            }

                            @if (inferenceResult != null)
                            {
                                <hr />
                                <h5>Extracted Fields:</h5>
                                <table class="table table-sm">
                                    <tbody>
                                        @if (inferenceResult.VendorName != null)
                                        {
                                            <tr>
                                                <th>Vendor</th>
                                                <td>@inferenceResult.VendorName.Value</td>
                                            </tr>
                                        }
                                        @if (inferenceResult.Date != null)
                                        {
                                            <tr>
                                                <th>Date</th>
                                                <td>@inferenceResult.Date.Value</td>
                                            </tr>
                                        }
                                        @if (inferenceResult.TotalAmount != null)
                                        {
                                            <tr>
                                                <th>Total</th>
                                                <td>@inferenceResult.TotalAmount.Value</td>
                                            </tr>
                                        }
                                        @if (inferenceResult.Subtotal != null)
                                        {
                                            <tr>
                                                <th>Subtotal</th>
                                                <td>@inferenceResult.Subtotal.Value</td>
                                            </tr>
                                        }
                                        @if (inferenceResult.TaxAmount != null)
                                        {
                                            <tr>
                                                <th>Tax</th>
                                                <td>@inferenceResult.TaxAmount.Value</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-muted p-5">
                            <i class="bi bi-gear" style="font-size: 4rem;"></i>
                            <p>Adjust settings and wait for preview</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Preprocessing Settings Panel -->
    @if (currentPhase == ProcessingPhase.Preprocessing)
    {
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Preprocessing Settings</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-check mb-3">
                            <InputCheckbox class="form-check-input" id="deskew"
                                   @bind-Value="settings.Deskew" @bind-Value:after="OnSettingsChanged" />
                            <label class="form-check-label" for="deskew">Deskew</label>
                        </div>
                        <div class="form-check mb-3">
                            <InputCheckbox class="form-check-input" id="denoise"
                                   @bind-Value="settings.Denoise" @bind-Value:after="OnSettingsChanged" />
                            <label class="form-check-label" for="denoise">Denoise</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="fuzzPercent" class="form-label">
                                Fuzz Percent: @settings.FuzzPercent %
                            </label>
                            <InputNumber type="range" class="form-range" id="fuzzPercent"
                                   min="0" max="100" step="5"
                                   @bind-Value="settings.FuzzPercent" @bind-Value:after="OnSettingsChanged" />
                        </div>
                        <div class="mb-3">
                            <label for="deskewThreshold" class="form-label">
                                Deskew Threshold: @settings.DeskewThreshold %
                            </label>
                            <InputNumber type="range" class="form-range" id="deskewThreshold"
                                   min="0" max="100" step="5"
                                   @bind-Value="settings.DeskewThreshold" @bind-Value:after="OnSettingsChanged" />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="contrastType" class="form-label">Contrast Type</label>
                            <InputSelect class="form-select" id="contrastType"
                                    @bind-Value="settings.ContrastType" @bind-Value:after="OnSettingsChanged">
                                <option value="sigmoidal">Sigmoidal</option>
                                <option value="linear">Linear</option>
                                <option value="none">None</option>
                            </InputSelect>
                        </div>
                        @if (settings.ContrastType == "sigmoidal")
                        {
                            <div class="mb-3">
                                <label for="contrastStrength" class="form-label">
                                    Contrast Strength: @settings.ContrastStrength.ToString("F1")
                                </label>
                                <InputNumber type="range" class="form-range" id="contrastStrength"
                                       min="1" max="10" step="0.5"
                                       @bind-Value="settings.ContrastStrength" @bind-Value:after="OnSettingsChanged" />
                            </div>
                            <div class="mb-3">
                                <label for="contrastMidpoint" class="form-label">
                                    Contrast Midpoint: @settings.ContrastMidpoint %
                                </label>
                                <InputNumber type="range" class="form-range" id="contrastMidpoint"
                                       min="0" max="200" step="10"
                                       @bind-Value="settings.ContrastMidpoint" @bind-Value:after="OnSettingsChanged" />
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Action Buttons -->
    <div class="d-flex justify-content-between mt-4">
        @if (currentPhase == ProcessingPhase.Ocr)
        {
            <button class="btn btn-secondary" onclick="@GoBack" disabled="@isLoading">
                <i class="bi bi-arrow-left me-2"></i>Go Back
            </button>
        }
        else
        {
            <button class="btn btn-secondary" onclick="@Reset" disabled="@isLoading">
                <i class="bi bi-arrow-counterclockwise me-2"></i>Reset
            </button>
        }

        @if (currentPhase == ProcessingPhase.Preprocessing && !string.IsNullOrEmpty(preprocessedImageBase64))
        {
            <button class="btn btn-primary" onclick="@AcceptPreprocessing" disabled="@isLoading">
                Done - Continue to OCR<i class="bi bi-arrow-right ms-2"></i>
            </button>
        }
        else if (currentPhase == ProcessingPhase.Ocr && inferenceResult != null)
        {
            <button class="btn btn-success" onclick="@AcceptResult">
                <i class="bi bi-check-lg me-2"></i>Accept Result
            </button>
        }
    </div>
</div>

@code {
    /// <summary>
    /// Event callback when the user accepts the final OCR result.
    /// </summary>
    [Parameter]
    public EventCallback<InferenceResult> OnResultAccepted { get; set; }

    /// <summary>
    /// Optional initial image as base64.
    /// </summary>
    [Parameter]
    public string? InitialImageBase64 { get; set; }

    private enum ProcessingPhase
    {
        Preprocessing,
        Ocr
    }

    private ProcessingPhase currentPhase = ProcessingPhase.Preprocessing;
    private string? sourceImageBase64;
    private string? preprocessedImageBase64;
    private string? errorMessage;
    private bool isLoading;
    private bool timerActive;
    private int timerSecondsRemaining = 5;
    private double timerProgress = 100;
    private string? currentJobId;

    private PreprocessingSettings settings = new();
    private OcrResult? ocrResult;
    private InferenceResult? inferenceResult;

    private System.Timers.Timer? updateTimer;
    private System.Timers.Timer? progressTimer;
    private DateTime lastSettingsChange;

    protected override void OnInitialized()
    {
        if (!string.IsNullOrEmpty(InitialImageBase64))
        {
            sourceImageBase64 = InitialImageBase64;
            OnSettingsChanged();
        }
    }

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrEmpty(InitialImageBase64) && sourceImageBase64 != InitialImageBase64)
        {
            sourceImageBase64 = InitialImageBase64;
            OnSettingsChanged();
        }
    }

    private async Task HandleFileSelection(InputFileChangeEventArgs e)
    {
        errorMessage = null;

        try
        {
            var file = e.File;
            if (file == null)
            {
                return;
            }

            // Validate file size (max 10MB)
            const long maxFileSize = 10 * 1024 * 1024;
            if (file.Size > maxFileSize)
            {
                errorMessage = "File size exceeds 10MB limit";
                await InvokeAsync(StateHasChanged);
                return;
            }

            // Validate file type
            if (!file.ContentType.StartsWith("image/"))
            {
                errorMessage = "Please select an image file";
                await InvokeAsync(StateHasChanged);
                return;
            }

            // Read file and convert to base64
            using var stream = file.OpenReadStream(maxFileSize);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            var bytes = memoryStream.ToArray();
            sourceImageBase64 = Convert.ToBase64String(bytes);

            // Clear previous results
            preprocessedImageBase64 = null;
            ocrResult = null;
            inferenceResult = null;
            currentPhase = ProcessingPhase.Preprocessing;

            // Trigger preprocessing
            OnSettingsChanged();

            Logger.LogInformation("Image selected: {FileName}, {Size} bytes", file.Name, file.Size);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error reading file: {ex.Message}";
            Logger.LogError(ex, "Error reading file");
        }

        await InvokeAsync(StateHasChanged);
    }

    private void OnSettingsChanged()
    {
        if (string.IsNullOrEmpty(sourceImageBase64))
            return;

        lastSettingsChange = DateTime.UtcNow;
        ResetTimer();
        StartTimer();
    }

    private void StartTimer()
    {
        timerActive = true;
        timerSecondsRemaining = 5;
        timerProgress = 100;

        updateTimer?.Stop();
        updateTimer = new System.Timers.Timer(5000);
        updateTimer.Elapsed += async (s, e) => await OnTimerElapsed();
        updateTimer.AutoReset = false;
        updateTimer.Start();

        progressTimer?.Stop();
        progressTimer = new System.Timers.Timer(200);
        progressTimer.Elapsed += OnProgressTick;
        progressTimer.AutoReset = true;
        progressTimer.Start();

        InvokeAsync(StateHasChanged);
    }

    private void ResetTimer()
    {
        updateTimer?.Stop();
        progressTimer?.Stop();
        timerActive = false;
        timerSecondsRemaining = 5;
        timerProgress = 100;
    }

    private void OnProgressTick(object? sender, ElapsedEventArgs e)
    {
        var elapsed = (DateTime.UtcNow - lastSettingsChange).TotalSeconds;
        timerSecondsRemaining = Math.Max(0, (int)Math.Ceiling(5 - elapsed));
        timerProgress = Math.Max(0, (5 - elapsed) / 5 * 100);
        InvokeAsync(StateHasChanged);
    }

    private async Task OnTimerElapsed()
    {
        ResetTimer();
        await InvokeAsync(async () =>
        {
            if (currentPhase == ProcessingPhase.Preprocessing)
            {
                await RunPreprocessing();
            }
        });
    }

    private async Task RunPreprocessing()
    {
        if (string.IsNullOrEmpty(sourceImageBase64))
            return;

        isLoading = true;
        errorMessage = null;
        currentJobId = Guid.NewGuid().ToString();
        await InvokeAsync(StateHasChanged);

        try
        {
            var request = new PreprocessingRequest
            {
                ImageBase64 = sourceImageBase64,
                JobId = currentJobId,
                Denoise = settings.Denoise,
                Deskew = settings.Deskew,
                FuzzPercent = settings.FuzzPercent,
                DeskewThreshold = settings.DeskewThreshold,
                ContrastType = settings.ContrastType,
                ContrastStrength = settings.ContrastStrength,
                ContrastMidpoint = settings.ContrastMidpoint
            };

            var result = await DocumentProcessingClient.PreprocessImageAsync(request);

            if (result != null && result.Status == "done")
            {
                preprocessedImageBase64 = result.ImageBase64;
                Logger.LogInformation("Preprocessing complete for job {JobId}", currentJobId);
            }
            else
            {
                errorMessage = result?.Error ?? "Preprocessing failed";
                Logger.LogWarning("Preprocessing failed: {Error}", errorMessage);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error during preprocessing: {ex.Message}";
            Logger.LogError(ex, "Error during preprocessing");
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task AcceptPreprocessing()
    {
        currentPhase = ProcessingPhase.Ocr;
        await RunOcrAndInference();
    }

    private async Task RunOcrAndInference()
    {
        if (string.IsNullOrEmpty(preprocessedImageBase64))
            return;

        isLoading = true;
        errorMessage = null;
        currentJobId = Guid.NewGuid().ToString();
        await InvokeAsync(StateHasChanged);

        try
        {
            // Run OCR
            var ocrRequest = new OcrRequest
            {
                ImageBase64 = preprocessedImageBase64,
                JobId = currentJobId,
                OcrEngine = "tesseract",
                TargetDpi = 300,
                Device = "auto"
            };

            var ocrResult = await DocumentProcessingClient.RunOcrAsync(ocrRequest);

            if (ocrResult == null || ocrResult.Status != "done")
            {
                errorMessage = ocrResult?.Error ?? "OCR failed";
                return;
            }

            Logger.LogInformation("OCR complete for job {JobId}, detected {WordCount} words",
                currentJobId, ocrResult.Words?.Count ?? 0);

            // Run Inference
            var inferenceRequest = new InferenceRequest
            {
                OcrResult = ocrResult,
                ImageBase64 = preprocessedImageBase64,
                JobId = currentJobId,
                Model = "naver-clova-ix/donut-base-finetuned-cord-v2",
                ModelType = "donut",
                Device = "auto"
            };

            var inferenceResult = await DocumentProcessingClient.RunInferenceAsync(inferenceRequest);

            if (inferenceResult == null || inferenceResult.Status != "done")
            {
                errorMessage = inferenceResult?.Error ?? "Inference failed";
                return;
            }

            Logger.LogInformation("Inference complete for job {JobId}", currentJobId);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error during OCR/inference: {ex.Message}";
            Logger.LogError(ex, "Error during OCR/inference");
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void GoBack()
    {
        currentPhase = ProcessingPhase.Preprocessing;
        ocrResult = null;
        inferenceResult = null;

        // Only trigger preprocessing if we don't have a result yet
        if (string.IsNullOrEmpty(preprocessedImageBase64))
        {
            OnSettingsChanged();
        }
        else
        {
            // Just switch view without re-running preprocessing
            StateHasChanged();
        }
    }

    private void Reset()
    {
        ResetTimer();
        sourceImageBase64 = null;
        preprocessedImageBase64 = null;
        ocrResult = null;
        inferenceResult = null;
        errorMessage = null;
        currentPhase = ProcessingPhase.Preprocessing;
        settings = new PreprocessingSettings();
        StateHasChanged();
    }

    private async Task AcceptResult()
    {
        if (inferenceResult != null)
        {
            await OnResultAccepted.InvokeAsync(inferenceResult);
        }
    }

    public void Dispose()
    {
        updateTimer?.Dispose();
        progressTimer?.Dispose();
    }

    // Settings class
    private class PreprocessingSettings
    {
        public bool Denoise { get; set; } = false;
        public bool Deskew { get; set; } = true;
        public int FuzzPercent { get; set; } = 30;
        public int DeskewThreshold { get; set; } = 40;
        public string ContrastType { get; set; } = "sigmoidal";
        public double ContrastStrength { get; set; } = 3.0;
        public int ContrastMidpoint { get; set; } = 120;
    }
}
